<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç¥ç»æ—¥å¿—</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Serif+SC:wght@300;400;600&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{--c:#00f5ff;--m:#ff0090;--y:#ffe600;--g:#00ff88;--dark:#030810;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Noto Serif SC',serif;color:#fff;}

/* â”€â”€ FEED â”€â”€ */
#feed{width:100%;height:100%;overflow-y:scroll;scroll-snap-type:y mandatory;scrollbar-width:none;}
#feed::-webkit-scrollbar{display:none;}

.slide{width:100%;height:100svh;scroll-snap-align:start;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;}
.slide-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.1);}
.slide-grain{position:absolute;inset:0;opacity:.04;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:128px;pointer-events:none;z-index:1;animation:gr .15s steps(1) infinite;}
@keyframes gr{0%{background-position:0 0}25%{background-position:50px -30px}50%{background-position:-20px 60px}75%{background-position:80px 20px}}
.slide-scan{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:2;}
.slide-vig{position:absolute;inset:0;background:radial-gradient(ellipse 120% 80% at 50% 100%,rgba(0,0,0,.92) 0%,transparent 60%),radial-gradient(ellipse 100% 60% at 50% 0%,rgba(0,0,0,.6) 0%,transparent 55%),radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.35) 100%);pointer-events:none;z-index:3;}
.slide-border{position:absolute;inset:0;box-shadow:inset 0 0 80px rgba(0,0,0,.8),inset 0 0 8px rgba(0,0,0,.95);pointer-events:none;z-index:4;}
.slide-accent{position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--c) 30%,var(--m) 70%,transparent);opacity:.6;z-index:5;}
.slide-nophoto{position:absolute;inset:0;z-index:0;}

.slide-content{position:relative;z-index:6;padding:0 26px 130px;}
.slide-dateline{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.slide-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.45);letter-spacing:3px;}
.slide-mood-dot{width:6px;height:6px;border-radius:50%;background:var(--c);box-shadow:0 0 8px var(--c);}
.slide-title{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;line-height:1.15;margin-bottom:14px;text-shadow:0 0 40px rgba(0,245,255,.5),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);}
.slide-title.hot{text-shadow:0 0 40px rgba(255,0,144,.7),0 2px 0 rgba(0,0,0,.8),0 4px 20px rgba(0,0,0,.9);}
.slide-quote{font-family:'Noto Serif SC',serif;font-weight:300;font-size:13px;line-height:2;color:rgba(255,255,255,.65);text-shadow:0 1px 8px rgba(0,0,0,1);margin-bottom:18px;border-left:2px solid rgba(0,245,255,.4);padding-left:12px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;}
.slide-footer{display:flex;align-items:center;justify-content:space-between;}
.slide-tags{display:flex;gap:6px;flex-wrap:wrap;}
.stag{font-family:'Share Tech Mono',monospace;font-size:9px;padding:3px 9px;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.55);letter-spacing:1px;backdrop-filter:blur(4px);background:rgba(0,0,0,.2);}
.slide-mood-big{font-size:28px;filter:drop-shadow(0 0 12px rgba(255,230,0,.7));}

/* Edit button on each slide */
.slide-edit-btn{position:absolute;top:60px;right:18px;z-index:7;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;backdrop-filter:blur(8px);transition:all .2s;}
.slide-edit-btn:active{border-color:var(--c);box-shadow:0 0 14px rgba(0,245,255,.3);}

/* â”€â”€ FLOATING COMPOSER â”€â”€ */
#composer{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:linear-gradient(180deg,rgba(3,8,16,0) 0%,rgba(3,8,16,.96) 18%);
  padding:0 0 calc(env(safe-area-inset-bottom,0px) + 12px);
  pointer-events:none;
  transition:transform .35s cubic-bezier(.22,1,.36,1);
}
#composer.expanded{background:rgba(3,8,16,.97);backdrop-filter:blur(24px);}
#composer::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,245,255,.2) 30%,rgba(255,0,144,.2) 70%,transparent);opacity:0;transition:opacity .3s;}
#composer.expanded::before{opacity:1;}

/* Mic pulse ring - always visible teaser */
#composer-teaser{
  display:flex;flex-direction:column;align-items:center;
  padding:10px 0 8px;pointer-events:all;
}
#mic-pulse-wrap{position:relative;width:72px;height:72px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
#mic-pulse-wrap::before,#mic-pulse-wrap::after{
  content:'';position:absolute;border-radius:50%;border:1px solid rgba(0,245,255,.25);
  animation:pr 2.4s ease-out infinite;
}
#mic-pulse-wrap::before{inset:-10px;animation-delay:0s;}
#mic-pulse-wrap::after{inset:-20px;animation-delay:.8s;}
@keyframes pr{0%{opacity:.5;transform:scale(1)}100%{opacity:0;transform:scale(1.4)}}
#mic-main-btn{
  width:72px;height:72px;border-radius:50%;
  background:rgba(3,8,16,.9);
  border:1.5px solid rgba(0,245,255,.6);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  font-size:28px;cursor:pointer;
  -webkit-user-select:none;user-select:none;touch-action:none;
  box-shadow:0 0 28px rgba(0,245,255,.2),inset 0 0 20px rgba(0,245,255,.04);
  transition:all .2s;pointer-events:all;
  position:relative;z-index:1;
}
#mic-main-btn.on{
  border-color:var(--m);
  background:rgba(20,0,10,.9);
  box-shadow:0 0 40px rgba(255,0,144,.4),inset 0 0 20px rgba(255,0,144,.08);
  animation:mr 1.2s ease infinite;
}
@keyframes mr{0%{box-shadow:0 0 0 0 rgba(255,0,144,.5),inset 0 0 20px rgba(255,0,144,.08)}70%{box-shadow:0 0 0 22px rgba(255,0,144,0),inset 0 0 20px rgba(255,0,144,.08)}100%{box-shadow:0 0 0 0 rgba(255,0,144,0),inset 0 0 20px rgba(255,0,144,.08)}}
.mic-main-label{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.5);letter-spacing:1.5px;}
.mic-main-label.on{color:var(--m);}
#composer-hint{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:2px;margin-top:6px;transition:opacity .3s;}
#composer.expanded #composer-hint{opacity:0;height:0;margin:0;overflow:hidden;}

/* Expanded area */
#composer-expand{
  max-height:0;overflow:hidden;
  transition:max-height .4s cubic-bezier(.22,1,.36,1);
  pointer-events:none;
}
#composer.expanded #composer-expand{max-height:420px;pointer-events:all;}

/* Preview image strip */
#comp-img-strip{
  display:flex;align-items:center;gap:10px;
  padding:0 20px 10px;
}
#comp-img-thumb{
  width:52px;height:52px;border-radius:6px;object-fit:cover;display:none;
  border:1px solid rgba(0,245,255,.3);
}
#comp-img-btn{
  width:52px;height:52px;border-radius:6px;
  border:1px dashed rgba(0,245,255,.25);
  background:rgba(0,245,255,.03);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  cursor:pointer;flex-shrink:0;transition:all .2s;
}
#comp-img-btn:active{border-color:var(--c);background:rgba(0,245,255,.08);}
#comp-img-btn span{font-size:18px;}
#comp-img-btn small{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.3);letter-spacing:1px;}

/* Mood bar */
#comp-mood-bar{
  display:flex;gap:6px;padding:0 20px 10px;overflow-x:auto;scrollbar-width:none;
}
#comp-mood-bar::-webkit-scrollbar{display:none;}
.mpick{flex-shrink:0;width:34px;height:34px;border-radius:9px;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all .18s;}
.mpick.sel{border-color:var(--c);background:rgba(0,245,255,.1);box-shadow:0 0 12px rgba(0,245,255,.25);transform:scale(1.1);}

/* Text row */
#comp-text-row{
  display:flex;align-items:flex-end;gap:10px;
  padding:0 14px 0 20px;
}
#transcript-text{
  flex:1;min-height:40px;max-height:110px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(0,245,255,.15);
  border-radius:4px;
  color:rgba(255,255,255,.88);
  font-family:'Noto Serif SC',serif;font-size:15px;line-height:1.7;
  padding:10px 14px;outline:none;resize:none;caret-color:var(--c);
  transition:border-color .2s;
}
#transcript-text:focus{border-color:rgba(0,245,255,.4);}
#transcript-text::placeholder{color:rgba(255,255,255,.18);font-size:13px;}
#interim-text{display:none;}
#save-btn{
  flex-shrink:0;width:44px;height:44px;
  background:var(--c);border:none;border-radius:4px;
  color:var(--dark);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);
  transition:all .2s;
}
#save-btn:active{box-shadow:0 0 24px rgba(0,245,255,.5);}

/* â”€â”€ TOP NAV â”€â”€ */
#top-nav{position:fixed;top:0;left:0;right:0;z-index:200;padding:max(env(safe-area-inset-top,0px),40px) 22px 14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
.nav-logo{font-family:'Orbitron',monospace;font-size:13px;font-weight:900;color:rgba(255,255,255,.9);letter-spacing:3px;text-shadow:0 0 20px rgba(0,245,255,.5);pointer-events:all;cursor:pointer;}
.nav-logo em{color:var(--c);font-style:normal;}
.nav-right{display:flex;align-items:center;gap:12px;pointer-events:all;}
.nav-dot{width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 8px #00ff88;animation:br 2.5s infinite;}
@keyframes br{0%,100%{opacity:1}50%{opacity:.3}}
.nav-rec{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.35);letter-spacing:2px;cursor:pointer;padding:6px 12px;border:1px solid rgba(255,255,255,.1);transition:all .2s;pointer-events:all;}
.nav-rec:active{border-color:var(--c);color:var(--c);}

/* â”€â”€ DOTS â”€â”€ */
#dots{position:fixed;right:8px;top:50%;transform:translateY(-50%);z-index:200;display:flex;flex-direction:column;gap:5px;}
.dot{width:2px;height:2px;border-radius:50%;background:rgba(255,255,255,.25);transition:all .3s;}
.dot.on{height:14px;border-radius:1px;background:var(--c);box-shadow:0 0 6px var(--c);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDIT PANEL (full-screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#edit-panel{
  position:fixed;inset:0;z-index:800;
  background:rgba(3,8,16,.97);
  backdrop-filter:blur(20px);
  display:none;flex-direction:column;
  overflow:hidden;
}
#edit-panel.show{display:flex;}
#edit-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}

.ep-header{
  position:relative;z-index:2;
  padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;
  border-bottom:1px solid rgba(0,245,255,.1);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.ep-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.ep-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .2s;}
.ep-close:active{border-color:var(--m);color:var(--m);}

.ep-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:18px;scrollbar-width:none;}
.ep-body::-webkit-scrollbar{display:none;}

/* Photo edit */
.ep-photo{width:100%;height:160px;position:relative;cursor:pointer;overflow:hidden;border:1px dashed rgba(0,245,255,.15);}
.ep-photo-img{width:100%;height:100%;object-fit:cover;display:none;}
.ep-photo-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
.ep-photo-lbl{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.35);letter-spacing:3px;}

/* Field label */
.ep-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.4);letter-spacing:3px;margin-bottom:6px;}

/* Title input */
.ep-title-input{width:100%;background:rgba(0,245,255,.03);border:1px solid rgba(0,245,255,.12);border-bottom:1px solid rgba(0,245,255,.25);color:rgba(255,255,255,.9);font-family:'Orbitron',monospace;font-size:18px;font-weight:700;padding:12px 14px;outline:none;letter-spacing:1px;caret-color:var(--c);}
.ep-title-input:focus{border-color:rgba(0,245,255,.4);}

/* Body textarea */
.ep-body-input{width:100%;min-height:160px;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.85);font-family:'Noto Serif SC',serif;font-size:15px;line-height:2;padding:14px;outline:none;resize:none;caret-color:var(--c);}
.ep-body-input:focus{border-color:rgba(0,245,255,.3);}

/* Tags input */
.ep-tags-input{width:100%;background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.1);color:rgba(255,255,255,.7);font-family:'Share Tech Mono',monospace;font-size:12px;padding:10px 14px;outline:none;caret-color:var(--c);letter-spacing:1px;}
.ep-tags-input:focus{border-color:rgba(0,245,255,.3);}
.ep-tags-hint{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:1px;margin-top:4px;}

/* Mood picker in edit */
.ep-mood-row{display:flex;gap:8px;flex-wrap:wrap;}
.emp{width:38px;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all .18s;}
.emp.sel{border-color:var(--c);background:rgba(0,245,255,.1);box-shadow:0 0 14px rgba(0,245,255,.25);transform:scale(1.1);}

/* Date display */
.ep-date-row{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);}

/* Danger zone */
.ep-delete{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,80,80,.4);letter-spacing:2px;padding:12px;border:1px solid rgba(255,80,80,.2);text-align:center;cursor:pointer;transition:all .2s;margin-bottom:20px;}
.ep-delete:active{color:#ff5050;border-color:#ff5050;background:rgba(255,80,80,.08);}

/* Bottom save bar */
.ep-footer{position:relative;z-index:2;flex-shrink:0;padding:14px 22px calc(env(safe-area-inset-bottom,0px) + 16px);border-top:1px solid rgba(0,245,255,.1);display:flex;gap:12px;}
.ep-save{flex:1;height:56px;background:var(--c);border:none;color:var(--dark);font-family:'Orbitron',monospace;font-size:13px;font-weight:900;letter-spacing:3px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;}
.ep-save:active{box-shadow:0 0 30px rgba(0,245,255,.5);}
.ep-mic-small{flex-shrink:0;width:56px;height:56px;border-radius:50%;border:1.5px solid rgba(0,245,255,.4);background:rgba(0,245,255,.05);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:20px;cursor:pointer;-webkit-user-select:none;user-select:none;touch-action:none;}
.ep-mic-small.on{border-color:var(--m);background:rgba(255,0,144,.1);animation:mr 1.2s ease infinite;}
.ep-mic-lbl{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(0,245,255,.5);letter-spacing:1px;}
.ep-mic-lbl.on{color:var(--m);}

/* â”€â”€ LISTEN OVERLAY â”€â”€ */
#listen-overlay{position:fixed;inset:0;z-index:900;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(3,8,16,.9);backdrop-filter:blur(16px);}
#listen-overlay.show{display:flex;}
.listen-ring{width:120px;height:120px;border-radius:50%;border:1.5px solid var(--m);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:28px;}
.listen-ring::before,.listen-ring::after{content:'';position:absolute;border-radius:50%;border:1px solid var(--m);animation:rp 1.8s ease-out infinite;}
.listen-ring::before{inset:-16px;animation-delay:0s;}
.listen-ring::after{inset:-32px;animation-delay:.6s;}
@keyframes rp{0%{opacity:.6;transform:scale(1)}100%{opacity:0;transform:scale(1.3)}}
.listen-mic{font-size:40px;}
.listen-wave{display:flex;gap:4px;align-items:center;height:44px;margin-bottom:20px;}
.lw-bar{width:3px;background:var(--m);border-radius:2px;box-shadow:0 0 6px var(--m);animation:lwa .5s ease-in-out infinite alternate;}
@keyframes lwa{from{height:4px}to{height:36px}}
.listen-txt{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.5);letter-spacing:3px;margin-bottom:8px;}
.listen-interim{font-family:'Noto Serif SC',serif;font-size:15px;color:rgba(255,255,255,.8);max-width:80%;text-align:center;line-height:1.8;min-height:24px;}
.listen-stop{margin-top:28px;font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.35);letter-spacing:2px;padding:10px 24px;border:1px solid rgba(255,255,255,.15);cursor:pointer;}
.listen-stop:active{border-color:var(--c);color:var(--c);}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:999;font-family:'Share Tech Mono',monospace;font-size:11px;padding:12px 24px;background:rgba(3,8,16,.95);border:1px solid var(--c);color:var(--c);letter-spacing:2px;white-space:nowrap;display:none;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);box-shadow:0 0 20px rgba(0,245,255,.2);}

/* â”€â”€ DELETE CONFIRM â”€â”€ */
#del-confirm{position:fixed;inset:0;z-index:950;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);}
#del-confirm.show{display:flex;}
.del-box{background:rgba(8,16,30,.98);border:1px solid rgba(255,80,80,.3);padding:32px 28px;max-width:300px;width:90%;text-align:center;}
.del-title{font-family:'Orbitron',monospace;font-size:14px;color:#ff5050;letter-spacing:2px;margin-bottom:12px;}
.del-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;margin-bottom:28px;line-height:1.8;}
.del-btns{display:flex;gap:12px;}
.del-cancel{flex:1;padding:12px;background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}
.del-ok{flex:1;padding:12px;background:rgba(255,80,80,.15);border:1px solid #ff5050;color:#ff5050;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;cursor:pointer;}

input[type=file]{display:none;}

/* â”€â”€ CALENDAR BUTTON â”€â”€ */
#cal-btn{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 130px);right:18px;z-index:400;width:46px;height:46px;border-radius:50%;background:rgba(3,8,16,.85);border:1px solid rgba(0,245,255,.35);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;backdrop-filter:blur(12px);box-shadow:0 0 18px rgba(0,245,255,.15);transition:all .2s;}
#cal-btn:active{border-color:var(--c);box-shadow:0 0 28px rgba(0,245,255,.4);}

/* â”€â”€ CALENDAR PANEL â”€â”€ */
#cal-panel{position:fixed;inset:0;z-index:850;display:none;flex-direction:column;background:rgba(3,8,16,.97);backdrop-filter:blur(24px);}
#cal-panel.show{display:flex;}
#cal-panel::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(0,245,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,.02) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;}

.cal-header{position:relative;z-index:2;padding:max(env(safe-area-inset-top,0px),52px) 22px 16px;border-bottom:1px solid rgba(0,245,255,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.cal-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--c);letter-spacing:4px;}
.cal-close{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;padding:8px 14px;border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .2s;}
.cal-close:active{border-color:var(--m);color:var(--m);}

.cal-body{position:relative;z-index:2;flex:1;overflow-y:auto;padding:20px 18px;scrollbar-width:none;display:flex;flex-direction:column;gap:20px;}
.cal-body::-webkit-scrollbar{display:none;}

/* Month nav */
.cal-month-nav{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.cal-nav-btn{width:38px;height:38px;border-radius:50%;border:1px solid rgba(0,245,255,.2);background:transparent;color:var(--c);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.cal-nav-btn:active{background:rgba(0,245,255,.12);border-color:var(--c);}
.cal-month-label{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:2px;text-align:center;flex:1;}

/* Calendar grid */
.cal-grid-wrap{background:rgba(0,245,255,.02);border:1px solid rgba(0,245,255,.08);}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid rgba(0,245,255,.06);}
.cal-wd{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,245,255,.35);letter-spacing:1px;text-align:center;padding:8px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);}
.cal-day{min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:all .15s;gap:3px;}
.cal-day:active{background:rgba(0,245,255,.06);}
.cal-day.empty{cursor:default;}
.cal-day-num{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(255,255,255,.45);transition:color .15s;}
.cal-day.has-entry .cal-day-num{color:rgba(255,255,255,.9);}
.cal-day.today .cal-day-num{color:var(--c);}
.cal-day.selected .cal-day-num{color:var(--dark);font-weight:700;}
.cal-day.selected{background:var(--c);}
.cal-day.selected::after{display:none;}
.cal-day-dot{width:4px;height:4px;border-radius:50%;background:var(--c);box-shadow:0 0 4px var(--c);}
.cal-day.today:not(.selected) .cal-day-num::after{content:'';position:absolute;bottom:6px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--c);}

/* Entry preview */
.cal-preview{border-top:1px solid rgba(0,245,255,.08);padding-top:4px;}
.cal-preview-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,.4);letter-spacing:2px;margin-bottom:12px;}
.cal-entry-card{padding:14px;border:1px solid rgba(0,245,255,.1);background:rgba(0,245,255,.02);cursor:pointer;transition:all .2s;margin-bottom:10px;}
.cal-entry-card:active{border-color:rgba(0,245,255,.4);background:rgba(0,245,255,.06);}
.cal-entry-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:6px;letter-spacing:1px;}
.cal-entry-body{font-family:'Noto Serif SC',serif;font-size:12px;color:rgba(255,255,255,.45);line-height:1.8;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cal-entry-meta{display:flex;align-items:center;gap:8px;margin-top:8px;}
.cal-entry-mood{font-size:16px;}
.cal-entry-tags{display:flex;gap:4px;flex-wrap:wrap;}
.cal-no-entry{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.2);letter-spacing:2px;text-align:center;padding:24px 0;}
</style>
</head>
<body>

<!-- Top nav -->
<div id="top-nav">
  <div class="nav-logo" onclick="goFeed()">NEURO<em>//</em>LOG</div>
  <div class="nav-right">
    <div class="nav-dot"></div>
  </div>
</div>

<!-- Dots -->
<div id="dots"></div>

<!-- Listen overlay -->
<div id="listen-overlay">
  <div class="listen-ring"><div class="listen-mic">ğŸ™ï¸</div></div>
  <div class="listen-wave" id="listen-wave"></div>
  <div class="listen-txt">â— æ­£åœ¨è†å¬</div>
  <div class="listen-interim" id="listen-interim">...</div>
  <div class="listen-stop" onclick="stopListen()">æ¾å¼€ / åœæ­¢</div>
</div>

<!-- Edit panel -->
<div id="edit-panel">
  <div class="ep-header">
    <div class="ep-title">// EDIT ENTRY</div>
    <div class="ep-close" onclick="closeEdit()">âœ• å–æ¶ˆ</div>
  </div>
  <div class="ep-body" id="ep-body">
    <!-- Photo -->
    <div>
      <div class="ep-label">// å°é¢ç…§ç‰‡</div>
      <div class="ep-photo" onclick="document.getElementById('ep-file').click()">
        <div class="ep-photo-placeholder">
          <div style="font-size:24px">ğŸ“·</div>
          <div class="ep-photo-lbl">ç‚¹å‡»æ›´æ¢ç…§ç‰‡</div>
        </div>
        <img class="ep-photo-img" id="ep-photo-img" src="" alt="">
      </div>
    </div>
    <!-- Date -->
    <div>
      <div class="ep-label">// æ—¥æœŸ</div>
      <div class="ep-date-row" id="ep-date-row"></div>
    </div>
    <!-- Title -->
    <div>
      <div class="ep-label">// æ ‡é¢˜</div>
      <input class="ep-title-input" id="ep-title-input" type="text" placeholder="æ ‡é¢˜...">
    </div>
    <!-- Body -->
    <div>
      <div class="ep-label">// æ­£æ–‡</div>
      <textarea class="ep-body-input" id="ep-body-input" rows="7" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
    </div>
    <!-- Mood -->
    <div>
      <div class="ep-label">// å¿ƒæƒ…</div>
      <div class="ep-mood-row" id="ep-mood-row">
        <div class="emp sel" onclick="epPickMood(this,'âœ¨')">âœ¨</div>
        <div class="emp" onclick="epPickMood(this,'ğŸ”¥')">ğŸ”¥</div>
        <div class="emp" onclick="epPickMood(this,'âš¡')">âš¡</div>
        <div class="emp" onclick="epPickMood(this,'ğŸŒŠ')">ğŸŒŠ</div>
        <div class="emp" onclick="epPickMood(this,'ğŸŒ‘')">ğŸŒ‘</div>
        <div class="emp" onclick="epPickMood(this,'ğŸ’«')">ğŸ’«</div>
        <div class="emp" onclick="epPickMood(this,'ğŸ¯')">ğŸ¯</div>
        <div class="emp" onclick="epPickMood(this,'ğŸŒ¸')">ğŸŒ¸</div>
      </div>
    </div>
    <!-- Tags -->
    <div>
      <div class="ep-label">// æ ‡ç­¾</div>
      <input class="ep-tags-input" id="ep-tags-input" type="text" placeholder="æ¼«æ¸¸ å¤œæ™š æ„Ÿæ‚Ÿ">
      <div class="ep-tags-hint">å¤šä¸ªæ ‡ç­¾ç”¨ç©ºæ ¼éš”å¼€</div>
    </div>
    <!-- Delete -->
    <div class="ep-delete" onclick="confirmDelete()">âš  åˆ é™¤è¿™æ¡æ—¥è®°</div>
  </div>
  <div class="ep-footer">
    <div class="ep-mic-small" id="ep-mic-btn"
      ontouchstart="startListen(event,'ep')"
      ontouchend="stopListen(event,'ep')"
      onmousedown="startListen(event,'ep')"
      onmouseup="stopListen(event,'ep')">
      <div>ğŸ™ï¸</div>
      <div class="ep-mic-lbl" id="ep-mic-lbl">æŒ‰ä½</div>
    </div>
    <button class="ep-save" onclick="saveEdit()">SAVE // ä¿å­˜ä¿®æ”¹</button>
  </div>
</div>

<!-- Delete confirm -->
<div id="del-confirm">
  <div class="del-box">
    <div class="del-title">DELETE ENTRY</div>
    <div class="del-sub">åˆ é™¤åæ— æ³•æ¢å¤<br>ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ</div>
    <div class="del-btns">
      <button class="del-cancel" onclick="document.getElementById('del-confirm').classList.remove('show')">å–æ¶ˆ</button>
      <button class="del-ok" onclick="doDelete()">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Calendar button -->
<div id="cal-btn" onclick="openCalendar()">ğŸ“…</div>

<!-- Floating Composer -->
<div id="composer">
  <!-- Always-visible teaser: just the mic button -->
  <div id="composer-teaser">
    <div id="mic-pulse-wrap">
      <div id="mic-main-btn"
        ontouchstart="handleMicTouch(event)"
        ontouchend="handleMicTouchEnd(event)"
        onmousedown="startListen(event,'new')"
        onmouseup="stopListen(event,'new')"
        onclick="expandComposer()">
        <div>ğŸ™ï¸</div>
        <div class="mic-main-label" id="mic-main-label">æŒ‰ä½è¯´è¯</div>
      </div>
    </div>
    <div id="composer-hint">TAP TO WRITE Â· HOLD TO SPEAK</div>
  </div>

  <!-- Expanded content -->
  <div id="composer-expand">
    <!-- Image + mood row -->
    <div id="comp-img-strip">
      <div id="comp-img-btn" onclick="document.getElementById('fileInput').click()">
        <span>ğŸ“·</span>
        <small>æ·»åŠ ç…§ç‰‡</small>
      </div>
      <img id="comp-img-thumb" src="" alt="">
      <div id="comp-mood-bar">
        <div class="mpick sel" onclick="pickMood(this,'âœ¨')">âœ¨</div>
        <div class="mpick" onclick="pickMood(this,'ğŸ”¥')">ğŸ”¥</div>
        <div class="mpick" onclick="pickMood(this,'âš¡')">âš¡</div>
        <div class="mpick" onclick="pickMood(this,'ğŸŒŠ')">ğŸŒŠ</div>
        <div class="mpick" onclick="pickMood(this,'ğŸŒ‘')">ğŸŒ‘</div>
        <div class="mpick" onclick="pickMood(this,'ğŸ’«')">ğŸ’«</div>
        <div class="mpick" onclick="pickMood(this,'ğŸ¯')">ğŸ¯</div>
        <div class="mpick" onclick="pickMood(this,'ğŸŒ¸')">ğŸŒ¸</div>
      </div>
    </div>
    <!-- Text input + send -->
    <div id="comp-text-row">
      <textarea id="transcript-text" rows="2" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„æ€ç»ªï¼Œæˆ–æŒ‰ä½éº¦å…‹é£è¯´è¯..."></textarea>
      <button id="save-btn" onclick="saveEntry()">â†‘</button>
    </div>
    <div id="interim-text"></div>
  </div>
</div>

<!-- Feed -->
<div id="feed"></div>

<!-- Calendar panel -->
<div id="cal-panel">
  <div class="cal-header">
    <div class="cal-title">// CALENDAR</div>
    <div class="cal-close" onclick="closeCalendar()">âœ• å…³é—­</div>
  </div>
  <div class="cal-body" id="cal-body">
    <div class="cal-month-nav">
      <button class="cal-nav-btn" onclick="calShift(-1)">â€¹</button>
      <div class="cal-month-label" id="cal-month-label"></div>
      <button class="cal-nav-btn" onclick="calShift(1)">â€º</button>
    </div>
    <div class="cal-grid-wrap">
      <div class="cal-weekdays">
        <div class="cal-wd">æ—¥</div><div class="cal-wd">ä¸€</div><div class="cal-wd">äºŒ</div>
        <div class="cal-wd">ä¸‰</div><div class="cal-wd">å››</div><div class="cal-wd">äº”</div><div class="cal-wd">å…­</div>
      </div>
      <div class="cal-days" id="cal-days"></div>
    </div>
    <div class="cal-preview" id="cal-preview"></div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" onchange="handleImg(this,'new')">
<input type="file" id="ep-file" accept="image/*" onchange="handleImg(this,'ep')">

<script>
/* â•â•â•â•â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•â•â•â• */
let entries = [
  {title:"äº‘å½©çš„è¯­è¨€",date:"2026.02.23",body:"å“‡å¡ï¼Œè¿™äº‘å½©ç»äº†ï¼éšæ‰‹ä¸€æ‹å°±æ˜¯å¤§ç‰‡ã€‚åŸå¸‚çš„å‘¼å¸åœ¨å…‰ä¸å½±ä¹‹é—´å‡å›ºï¼Œæ¯ä¸€ç§’éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„å­˜åœ¨ã€‚",mood:"âœ¨",tags:["å¤©ç©º","å‚æ™š"],img:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80"},
  {title:"é•¿è¡—æ¼«è¡Œ",date:"2026.02.21",body:"å…‰çº¿æŠ˜å°„çš„ç¬é—´ï¼Œæˆ‘ä»¬æŠŠè®°å¿†ç§åœ¨èŠ±å›­é‡Œã€‚éœ“è™¹ä¸çŸ³æ¿è·¯çš„å¯¹è¯ï¼Œåªæœ‰æ·±å¤œæ‰èƒ½å¬è§ã€‚",mood:"ğŸŒŠ",tags:["å¤œæ™š","æ¼«æ¸¸"],img:"https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&q=80"},
  {title:"DEEP FOCUS",date:"2026.02.19",body:"è¿ç»­å…­å°æ—¶çš„å¿ƒæµçŠ¶æ€ã€‚ä»£ç å°±åƒæ°´ä¸€æ ·æµæ·Œï¼Œé€»è¾‘åœ¨è„‘æµ·é‡Œè‡ªåŠ¨å±•å¼€ã€‚è¿™ç§æ„Ÿè§‰å¾ˆå°‘å‡ºç°ï¼Œè¦çæƒœã€‚",mood:"âš¡",tags:["å·¥ä½œ","å¿ƒæµ"],img:"https://images.unsplash.com/photo-1518770660439-4636190af475?w=800&q=80"},
];

// Load from localStorage if available
try {
  const saved = localStorage.getItem('neuro_entries');
  if(saved) entries = JSON.parse(saved);
} catch(e){}

function persist(){
  try { localStorage.setItem('neuro_entries', JSON.stringify(entries)); } catch(e){}
}

let currentMood = 'âœ¨';
let imgDataUrl = null;
let epImgDataUrl = null;
let editingIdx = null;
let recognition = null;
let isListening = false;
let listenTarget = 'new'; // 'new' or 'ep'
let finalTranscript = '';

/* â•â•â•â•â•â•â•â•â•â•â• BUILD FEED â•â•â•â•â•â•â•â•â•â•â• */
function buildFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  entries.forEach((e,i) => {
    const slide = document.createElement('div');
    slide.className = 'slide';
    slide.dataset.i = i;

    const noc = [['#001a2e','#002a4a','#00f5ff'],['#1a0010','#2e0020','#ff0090'],['#1a1000','#2e1a00','#ffe600']];
    const nc = noc[i%3];

    if(e.img){
      const bg = document.createElement('img');
      bg.className = 'slide-bg';
      bg.src = e.img;
      slide.appendChild(bg);
    } else {
      const np = document.createElement('div');
      np.className = 'slide-nophoto';
      const cv = document.createElement('canvas');
      cv.id = 'pc'+i;
      cv.style.cssText = 'width:100%;height:100%;';
      np.appendChild(cv);
      slide.appendChild(np);
    }

    slide.innerHTML += `
      <div class="slide-grain"></div>
      <div class="slide-scan"></div>
      <div class="slide-vig"></div>
      <div class="slide-border"></div>
      <div class="slide-accent"></div>
      <div class="slide-edit-btn" onclick="openEdit(${i})">âœï¸</div>
      <div class="slide-content">
        <div class="slide-dateline">
          <div class="slide-date">${e.date}</div>
          <div class="slide-mood-dot" style="background:${moodColor(e.mood)};box-shadow:0 0 8px ${moodColor(e.mood)}"></div>
        </div>
        <div class="slide-title${['ğŸ”¥','ğŸ’¥'].includes(e.mood)?' hot':''}">${e.title}</div>
        <div class="slide-quote">${e.body}</div>
        <div class="slide-footer">
          <div class="slide-tags">${e.tags.map(t=>`<span class="stag">${t}</span>`).join('')}</div>
          <div class="slide-mood-big">${e.mood}</div>
        </div>
      </div>`;

    feed.appendChild(slide);

    if(!e.img){
      setTimeout(()=>{
        const c = document.getElementById('pc'+i);
        if(c) initParticles(c, nc[0], nc[1], nc[2]);
      },80);
    }
  });

  // No more write slide - composer is fixed overlay
  buildDots();

  feed.removeEventListener('scroll', onScroll);
  feed.addEventListener('scroll', onScroll, {passive:true});
}

function moodColor(m){
  return {'âœ¨':'#00f5ff','ğŸ”¥':'#ff4400','âš¡':'#ffe600','ğŸŒŠ':'#0088ff','ğŸŒ‘':'#8888aa','ğŸ’«':'#ff00ff','ğŸ¯':'#00ff88','ğŸŒ¸':'#ff88cc'}[m]||'#00f5ff';
}

/* â•â•â•â•â•â•â•â•â•â•â• PARTICLES â•â•â•â•â•â•â•â•â•â•â• */
function initParticles(canvas,dark,mid,accent){
  const par = canvas.parentElement;
  canvas.width = par.offsetWidth||window.innerWidth;
  canvas.height = par.offsetHeight||window.innerHeight;
  const ctx = canvas.getContext('2d');
  const g = ctx.createRadialGradient(canvas.width*.5,canvas.height*.4,0,canvas.width*.5,canvas.height*.6,canvas.width*.9);
  g.addColorStop(0,mid); g.addColorStop(1,dark);
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  const pts = Array.from({length:80},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2+.3,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,a:Math.random()*.5+.15}));
  function draw(){
    ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    pts.forEach(p=>{
      ctx.save(); ctx.globalAlpha=p.a; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=accent; ctx.shadowColor=accent; ctx.shadowBlur=6; ctx.fill(); ctx.restore();
      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0||p.x>canvas.width)p.vx*=-1; if(p.y<0||p.y>canvas.height)p.vy*=-1;
    });
    if(canvas.isConnected) requestAnimationFrame(draw);
  }
  draw();
}

/* â•â•â•â•â•â•â•â•â•â•â• COMPOSER â•â•â•â•â•â•â•â•â•â•â• */
let composerExpanded = false;

function expandComposer(){
  if(composerExpanded) return;
  composerExpanded = true;
  document.getElementById('composer').classList.add('expanded');
  // Update mic button label
  const lbl = document.getElementById('mic-main-label');
  if(lbl) lbl.textContent = 'æŒ‰ä½è¯´è¯';
  setTimeout(()=>document.getElementById('transcript-text')?.focus(), 400);
}

function collapseComposer(){
  composerExpanded = false;
  document.getElementById('composer').classList.remove('expanded');
  document.getElementById('transcript-text')?.blur();
}

// Handle mic touch on mobile: short tap = expand; long press = listen
let micTouchTimer = null;
let micTouchMoved = false;

function handleMicTouch(e){
  e.preventDefault();
  micTouchMoved = false;
  micTouchTimer = setTimeout(()=>{
    // Long press - start listening
    startListen(e,'new');
  }, 200);
}

function handleMicTouchEnd(e){
  e.preventDefault();
  if(micTouchTimer){ clearTimeout(micTouchTimer); micTouchTimer=null; }
  if(isListening){
    stopListen(e,'new');
  } else {
    expandComposer();
  }
}

// Collapse when tapping outside composer
document.addEventListener('touchstart', (e)=>{
  if(composerExpanded && !document.getElementById('composer').contains(e.target)){
    // Only collapse if textarea is empty
    const txt = document.getElementById('transcript-text');
    if(!txt || !txt.value.trim()) collapseComposer();
  }
}, {passive:true});


/* â•â•â•â•â•â•â•â•â•â•â• DOTS â•â•â•â•â•â•â•â•â•â•â• */
function buildDots(){
  const w=document.getElementById('dots'); w.innerHTML='';
  for(let i=0;i<entries.length+1;i++){
    const d=document.createElement('div');
    d.className='dot'+(i===0?' on':'');
    w.appendChild(d);
  }
}

function onScroll(){
  const feed=document.getElementById('feed');
  const idx=Math.round(feed.scrollTop/feed.clientHeight);
  document.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('on',i===idx));
}

/* â•â•â•â•â•â•â•â•â•â•â• VOICE â•â•â•â•â•â•â•â•â•â•â• */
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

function setupSpeech(){
  // Always recreate to avoid stale recognition objects after buildFeed
  if(recognition){ try{recognition.abort();}catch(e){} recognition=null; }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR) return;
  recognition=new SR();
  recognition.lang='zh-CN';
  // iOS Safari does NOT support continuous=true reliably; use false and restart manually
  recognition.continuous = !isIOS;
  recognition.interimResults=true;

  recognition.onresult=(e)=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal) finalTranscript+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    const interimEl=document.getElementById('listen-interim');
    if(interimEl) interimEl.textContent=(finalTranscript+interim)||'...';
  };

  recognition.onend=()=>{
    // On iOS, restart if still in listening mode (simulates continuous)
    if(isListening && isIOS && recognition){
      try{ recognition.start(); }catch(err){}
    }
  };

  recognition.onerror=(ev)=>{
    // 'not-allowed' means mic permission denied
    if(ev.error==='not-allowed'||ev.error==='service-not-allowed'){
      isListening=false;
      commitAndClose();
      showToast('âš  è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£æƒé™');
    }
    // 'no-speech' on iOS is normal, just restart
    if(ev.error==='no-speech' && isIOS && isListening){
      try{ recognition.start(); }catch(err){}
    }
  };
}

function startListen(e, target){
  e.preventDefault();
  e.stopPropagation();
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ showToast('æ­¤æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥'); return; }
  // Re-init if needed (handles cases where recognition was torn down)
  if(!recognition) setupSpeech();

  listenTarget = target;
  isListening = true;
  // Seed finalTranscript with existing textarea content
  if(target==='new') finalTranscript=(document.getElementById('transcript-text')||{}).value||'';
  else finalTranscript=(document.getElementById('ep-body-input')||{}).value||'';

  try{ recognition.start(); }catch(err){
    // Already started (e.g. double-tap), ignore
  }

  document.getElementById('listen-overlay').classList.add('show');
  const interimEl=document.getElementById('listen-interim');
  if(interimEl) interimEl.textContent='...';

  // Mic button states
  if(target==='new'){
    expandComposer();
    document.getElementById('mic-main-btn')?.classList.add('on');
    const ml=document.getElementById('mic-main-label');
    if(ml){ ml.classList.add('on'); ml.textContent='è†å¬ä¸­'; }
  } else {
    document.getElementById('ep-mic-btn')?.classList.add('on');
    const ml=document.getElementById('ep-mic-lbl');
    if(ml){ ml.classList.add('on'); ml.textContent='è†å¬'; }
  }

  // Wave bars
  const wv=document.getElementById('listen-wave'); if(wv){ wv.innerHTML='';
    for(let i=0;i<20;i++){
      const b=document.createElement('div'); b.className='lw-bar';
      b.style.animationDelay=(i*.06)+'s';
      b.style.animationDuration=(.35+Math.random()*.3)+'s';
      wv.appendChild(b);
    }
  }
}

function commitAndClose(){
  // Write final text back to correct target
  if(listenTarget==='new'){
    const el=document.getElementById('transcript-text');
    if(el && finalTranscript) el.value=finalTranscript;
    document.getElementById('mic-main-btn')?.classList.remove('on');
    const ml=document.getElementById('mic-main-label');
    if(ml){ ml.classList.remove('on'); ml.textContent='æŒ‰ä½è¯´è¯'; }
  } else {
    const el=document.getElementById('ep-body-input');
    if(el && finalTranscript) el.value=finalTranscript;
    document.getElementById('ep-mic-btn')?.classList.remove('on');
    const ml=document.getElementById('ep-mic-lbl');
    if(ml){ ml.classList.remove('on'); ml.textContent='æŒ‰ä½'; }
  }
  document.getElementById('listen-overlay').classList.remove('show');
}

function stopListen(e, target){
  if(e){ e.preventDefault(); e.stopPropagation(); }
  if(!isListening) return;
  isListening=false;
  if(recognition){ try{recognition.stop();}catch(err){} }
  // Small delay so final onresult fires before we commit
  setTimeout(commitAndClose, isIOS ? 600 : 200);
}

/* â•â•â•â•â•â•â•â•â•â•â• NEW ENTRY â•â•â•â•â•â•â•â•â•â•â• */
function pickMood(el,m){
  document.querySelectorAll('.mpick').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); currentMood=m;
}

function handleImg(input, target){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    if(target==='new'){
      imgDataUrl=e.target.result;
      const thumb=document.getElementById('comp-img-thumb');
      if(thumb){thumb.src=imgDataUrl;thumb.style.display='block';}
      const btn=document.getElementById('comp-img-btn');
      if(btn) btn.querySelector('small').textContent='æ›´æ¢ç…§ç‰‡';
    } else {
      epImgDataUrl=e.target.result;
      const img=document.getElementById('ep-photo-img');
      if(img){img.src=epImgDataUrl;img.style.display='block';}
      const lbl=document.querySelector('.ep-photo-lbl');
      if(lbl) lbl.textContent='ç‚¹å‡»æ›´æ¢ç…§ç‰‡';
    }
  };
  reader.readAsDataURL(file);
}

function saveEntry(){
  const text=(document.getElementById('transcript-text').value||'').trim();
  if(!text){ showToast('è¯·å…ˆè¯´ç‚¹ä»€ä¹ˆæˆ–è¾“å…¥æ–‡å­— âœ¦'); return; }
  const now=new Date();
  const ds=`${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
  const fc=text.replace(/[ï¼Œã€‚ï¼ï¼Ÿ,.!?\n]/,'Â§').split('Â§')[0].slice(0,12);
  entries.unshift({title:fc||'ä»Šæ—¥è®°å½•',date:ds,body:text,mood:currentMood,tags:['è¯­éŸ³æ—¥è®°'],img:imgDataUrl||null});
  persist();

  // Reset composer
  document.getElementById('transcript-text').value='';
  finalTranscript=''; imgDataUrl=null;
  const thumb=document.getElementById('comp-img-thumb');
  if(thumb){thumb.style.display='none';thumb.src='';}
  const imgBtn=document.getElementById('comp-img-btn');
  if(imgBtn) imgBtn.querySelector('small').textContent='æ·»åŠ ç…§ç‰‡';
  document.getElementById('fileInput').value='';
  document.querySelectorAll('.mpick').forEach((b,i)=>b.classList.toggle('sel',i===0));
  currentMood='âœ¨';

  collapseComposer();
  buildFeed(); setupSpeech();
  showToast('âœ“ å·²å†™å…¥ç¥ç»æ—¥å¿—');
  setTimeout(()=>document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}),350);
}

/* â•â•â•â•â•â•â•â•â•â•â• EDIT â•â•â•â•â•â•â•â•â•â•â• */
function openEdit(idx){
  editingIdx = idx;
  const e = entries[idx];

  // Populate fields
  document.getElementById('ep-date-row').textContent = e.date;
  document.getElementById('ep-title-input').value = e.title;
  document.getElementById('ep-body-input').value = e.body;
  document.getElementById('ep-tags-input').value = e.tags.join(' ');

  // Photo
  const img = document.getElementById('ep-photo-img');
  const lbl = document.querySelector('.ep-photo-lbl');
  if(e.img){
    img.src = e.img; img.style.display='block';
    epImgDataUrl = e.img;
    if(lbl) lbl.textContent='ç‚¹å‡»æ›´æ¢ç…§ç‰‡';
  } else {
    img.style.display='none'; img.src='';
    epImgDataUrl = null;
    if(lbl) lbl.textContent='ç‚¹å‡»æ·»åŠ ç…§ç‰‡';
  }

  // Mood
  const moods = ['âœ¨','ğŸ”¥','âš¡','ğŸŒŠ','ğŸŒ‘','ğŸ’«','ğŸ¯','ğŸŒ¸'];
  document.querySelectorAll('.emp').forEach((el,i)=>{
    el.classList.toggle('sel', moods[i]===e.mood);
  });
  editMood = e.mood;

  // Scroll ep-body to top
  document.getElementById('ep-body').scrollTop = 0;

  document.getElementById('edit-panel').classList.add('show');
}

let editMood = 'âœ¨';
function epPickMood(el,m){
  document.querySelectorAll('.emp').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); editMood=m;
}

function closeEdit(){
  document.getElementById('edit-panel').classList.remove('show');
  editingIdx=null;
  document.getElementById('ep-file').value='';
}

function saveEdit(){
  if(editingIdx===null) return;
  const title=(document.getElementById('ep-title-input').value||'').trim();
  const body=(document.getElementById('ep-body-input').value||'').trim();
  const tagsRaw=(document.getElementById('ep-tags-input').value||'').trim();
  const tags=tagsRaw?tagsRaw.split(/\s+/).filter(Boolean):['æ—¥è®°'];

  if(!body){ showToast('æ­£æ–‡ä¸èƒ½ä¸ºç©º âœ¦'); return; }

  entries[editingIdx] = {
    ...entries[editingIdx],
    title: title||entries[editingIdx].title,
    body,
    tags,
    mood: editMood,
    img: epImgDataUrl||null,
  };

  persist();
  closeEdit();
  buildFeed(); setupSpeech();
  showToast('âœ“ ä¿®æ”¹å·²ä¿å­˜');

  // Scroll back to edited slide
  setTimeout(()=>{
    const feed=document.getElementById('feed');
    feed.scrollTo({top: editingIdx * feed.clientHeight, behavior:'smooth'});
  },350);
}

/* â•â•â•â•â•â•â•â•â•â•â• DELETE â•â•â•â•â•â•â•â•â•â•â• */
function confirmDelete(){
  document.getElementById('del-confirm').classList.add('show');
}

function doDelete(){
  document.getElementById('del-confirm').classList.remove('show');
  if(editingIdx===null) return;
  entries.splice(editingIdx,1);
  persist();
  closeEdit();
  buildFeed(); setupSpeech();
  showToast('æ—¥è®°å·²åˆ é™¤');
}

/* â•â•â•â•â•â•â•â•â•â•â• CALENDAR â•â•â•â•â•â•â•â•â•â•â• */
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-indexed
let calSelected = null; // 'YYYY.MM.DD' string

function openCalendar(){
  const now = new Date();
  calYear = now.getFullYear(); calMonth = now.getMonth();
  calSelected = null;
  renderCalendar();
  document.getElementById('cal-panel').classList.add('show');
}

function closeCalendar(){
  document.getElementById('cal-panel').classList.remove('show');
}

function calShift(dir){
  calMonth += dir;
  if(calMonth < 0){ calMonth = 11; calYear--; }
  if(calMonth > 11){ calMonth = 0; calYear++; }
  renderCalendar();
}

function renderCalendar(){
  const months=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
  document.getElementById('cal-month-label').textContent = `${calYear} Â· ${months[calMonth]}`;

  const firstDay = new Date(calYear, calMonth, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  const today = new Date();
  const todayStr = `${today.getFullYear()}.${String(today.getMonth()+1).padStart(2,'0')}.${String(today.getDate()).padStart(2,'0')}`;

  // Build a set of dates that have entries for fast lookup
  const entryDates = new Set(entries.map(e=>e.date));

  const grid = document.getElementById('cal-days');
  grid.innerHTML = '';

  // Empty cells before first day
  for(let i=0;i<firstDay;i++){
    const cell=document.createElement('div');
    cell.className='cal-day empty';
    grid.appendChild(cell);
  }

  for(let d=1;d<=daysInMonth;d++){
    const dateStr=`${calYear}.${String(calMonth+1).padStart(2,'0')}.${String(d).padStart(2,'0')}`;
    const hasEntry = entryDates.has(dateStr);
    const isToday = dateStr===todayStr;
    const isSel = dateStr===calSelected;

    const cell=document.createElement('div');
    cell.className='cal-day'+(hasEntry?' has-entry':'')+(isToday?' today':'')+(isSel?' selected':'');
    cell.innerHTML=`<div class="cal-day-num">${d}</div>${hasEntry&&!isSel?'<div class="cal-day-dot"></div>':''}`;
    cell.onclick=()=>selectCalDay(dateStr);
    grid.appendChild(cell);
  }

  renderCalPreview();
}

function selectCalDay(dateStr){
  calSelected = calSelected===dateStr ? null : dateStr;
  renderCalendar();
}

function renderCalPreview(){
  const preview = document.getElementById('cal-preview');
  if(!calSelected){ preview.innerHTML=''; return; }

  const dayEntries = entries.filter(e=>e.date===calSelected);
  const parts = calSelected.split('.');
  const label = `${parts[0]}å¹´${Number(parts[1])}æœˆ${Number(parts[2])}æ—¥`;

  let html=`<div class="cal-preview-date">// ${label}</div>`;
  if(dayEntries.length===0){
    html+=`<div class="cal-no-entry">è¿™å¤©æ²¡æœ‰æ—¥è®°</div>`;
  } else {
    dayEntries.forEach((e,i)=>{
      const idx = entries.indexOf(e);
      const tagsHtml = e.tags.map(t=>`<span class="stag" style="font-size:8px;">${t}</span>`).join('');
      html+=`<div class="cal-entry-card" onclick="goToEntry(${idx})">
        <div class="cal-entry-title">${e.title}</div>
        <div class="cal-entry-body">${e.body}</div>
        <div class="cal-entry-meta">
          <div class="cal-entry-mood">${e.mood}</div>
          <div class="cal-entry-tags">${tagsHtml}</div>
        </div>
      </div>`;
    });
  }
  preview.innerHTML=html;
}

function goToEntry(idx){
  closeCalendar();
  setTimeout(()=>{
    const feed=document.getElementById('feed');
    feed.scrollTo({top: idx * feed.clientHeight, behavior:'smooth'});
  }, 300);
}

/* â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â• */
function goFeed(){ document.getElementById('feed').scrollTo({top:0,behavior:'smooth'}); collapseComposer(); }
function goWrite(){ expandComposer(); }

/* â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block';
  clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none',2400);
}

/* â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â• */
buildFeed();
setupSpeech();
</script>
</body>
</html>
